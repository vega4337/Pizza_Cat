<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>üçïüê± Pizza Cat ‚Äî Drop Edition</title>
<style>
  :root{
    --bg:#fff7ee; --panel:#ffe3c4; --ink:#3f3025; --accent:#ff9f43;
    --ok:#2ecc71; --bad:#e74c3c; --shadow:rgba(0,0,0,.12);
    --dough:#f6d3a8; --crust:#e0a76b; --board:#fbe3c9; --wood1:#f6d6a8; --wood2:#e9c38f;
  }
  *{box-sizing:border-box}
  html,body{height:100%;max-width:100%;overflow-x:hidden;background:var(--bg);color:var(--ink)}
  body{
    margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    display:flex; align-items:center; justify-content:center; padding:14px; -webkit-user-select:none; user-select:none;
  }
  .wrap{width:min(920px,100%); margin:0 auto;}
  header{
    background:var(--panel); border-radius:14px; padding:10px 12px; box-shadow:0 6px 18px var(--shadow);
    display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
  }
  .title{font-weight:900;font-size:19px}
  .badges{display:flex; gap:8px; flex-wrap:wrap}
  .badge{background:#fff;border-radius:10px;padding:6px 10px;min-width:92px;text-align:center;box-shadow:0 4px 12px var(--shadow)}
  .badge .l{font-size:11px;opacity:.7}.badge .v{font-weight:900;font-size:18px}
  .controls{display:flex;gap:8px}
  button{appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:800;cursor:pointer;box-shadow:0 6px 18px var(--shadow)}
  .primary{background:var(--accent);color:#fff}
  .secondary{background:#fff;color:var(--accent);border:2px solid var(--accent)}
  .mute{min-width:44px}

  main{display:grid;grid-template-columns:1.25fr .75fr;gap:12px;margin-top:12px}
  @media(max-width:980px){main{grid-template-columns:1fr}}
  .stage{background:var(--board);border-radius:16px;padding:12px;box-shadow:0 12px 28px var(--shadow);position:relative;overflow:hidden}
  .right{display:flex;flex-direction:column;gap:10px}
  .panel{background:#fff;border-radius:14px;padding:12px;box-shadow:0 8px 22px var(--shadow)}
  .order h3{margin:0 0 6px;font-size:16px}
  .reqs{display:flex;gap:8px;flex-wrap:wrap}
  .req{background:var(--panel);border-radius:10px;padding:6px 8px;display:flex;align-items:center;gap:6px;font-weight:800}
  .req.done{opacity:.4;text-decoration:line-through}
  .bubble{border:2px dashed var(--accent);border-radius:14px;padding:10px 12px;min-height:54px}
  .ok{border-color:var(--ok)!important}.bad{border-color:var(--bad)!important}

  /* Cat box ‚Äì tall for long drop */
  .catbox{
    position:relative;height:300px;background:#fff;border-radius:14px;box-shadow:0 8px 22px var(--shadow);
    display:flex;align-items:center;justify-content:center;overflow:hidden
  }
  svg{max-width:100%;height:100%}
  .paw{transform-origin:center;animation:pawIdle 1.6s ease-in-out infinite}
  .paw.drop{animation:pawDrop .55s ease-in-out 1}
  @keyframes pawIdle{0%,100%{transform:rotate(0)}50%{transform:rotate(2deg)}}
  @keyframes pawDrop{0%{transform:translateY(0)}60%{transform:translateY(16px)}100%{transform:translateY(0)}}
  /* blink */
  .eye{transform-origin:center}
  .blink{animation:blink 4.5s infinite}
  @keyframes blink{0%,4%,100%{transform:scaleY(1)}2%{transform:scaleY(.1)}}

  /* Falling item */
  .fall{
    position:absolute; left:50%; transform:translateX(-50%);
    font-size:48px; filter: drop-shadow(0 2px 1px rgba(0,0,0,.15));
    pointer-events:none; transition: transform .08s ease;
  }
  .fall.squash{transform:translateX(-50%) scale(1.05,.92)}

  /* Table + pizza for long trajectory */
  .table{
    position:relative; margin:26px auto 8px; width:min(96vmin,720px);
    aspect-ratio: 5/3; border-radius:18px;
    background:linear-gradient(145deg,var(--wood1),var(--wood2));
    box-shadow: inset 0 8px 18px rgba(0,0,0,.08), 0 10px 26px var(--shadow);
    display:flex; align-items:flex-start; justify-content:center; padding-top:46px; max-width:100%;
  }
  .pizza-zone{position:relative;width:min(86vmin,620px);aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;max-width:100%}
  .pizza{
    width:84%; height:84%; border-radius:50%;
    background: radial-gradient(circle at 50% 45%, var(--dough) 0 58%, var(--crust) 60% 100%);
    box-shadow: inset 0 12px 24px rgba(0,0,0,.08), 0 12px 22px rgba(0,0,0,.18);
    position:relative; overflow:hidden; transform:perspective(900px) rotateX(18deg);
  }
  .table-shadow{position:absolute; bottom:14px; width:62%; height:12%; left:50%; transform:translateX(-50%); background:radial-gradient(ellipse at center, rgba(0,0,0,.22), transparent 65%); filter:blur(10px); opacity:.35; pointer-events:none}
  .ring{position:absolute; inset:0; border-radius:50%; border:3px dashed rgba(0,0,0,.07); pointer-events:none}
  .spot{position:absolute; font-size:clamp(22px,4.5vmin,38px); transform:translate(-50%,-50%); filter:drop-shadow(0 2px 1px rgba(0,0,0,.15))}

  /* Combo badge */
  .combo{
    position:absolute; top:6px; right:10px; background:#fff; border:2px solid var(--accent);
    border-radius:999px; padding:6px 10px; font-weight:900; display:none;
  }

  /* Overlay */
  .overlay{position:fixed; inset:0; background:rgba(255,247,238,.96); display:none; align-items:center; justify-content:center; padding:18px; z-index:50}
  .overlay.show{display:flex}
  .card{background:#fff; border-radius:16px; padding:18px; width:min(560px,96%); text-align:center; box-shadow:0 16px 40px rgba(0,0,0,.18)}
  .card h2{margin:0 0 6px}
  .grid{display:flex; gap:6px; flex-wrap:wrap; justify-content:center}
  .pill{background:var(--panel); border-radius:999px; padding:6px 10px; font-weight:800}
  .ghost{opacity:.4}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">üçïüê± <strong>Pizza Cat</strong> ‚Äî Drop Edition</div>
      <div class="badges">
        <div class="badge"><div class="l">LEVEL</div><div class="v" id="uiLevel">1</div></div>
        <div class="badge"><div class="l">TIME</div><div class="v" id="uiTime">30</div></div>
        <div class="badge"><div class="l">SCORE</div><div class="v" id="uiScore">0</div></div>
        <div class="badge"><div class="l">BEST</div><div class="v" id="uiBest">0</div></div>
      </div>
      <div class="controls">
        <button class="primary" id="btnStart">Start</button>
        <button class="secondary" id="btnPause">Pause</button>
        <button class="secondary mute" id="btnSound">üîä</button>
      </div>
    </header>

    <main>
      <section class="stage">
        <!-- Calico cat SVG (with blink) -->
        <div class="catbox">
          <svg viewBox="0 0 420 300" aria-label="Calico cat chef">
            <!-- tail with improved shading -->
            <defs>
              <radialGradient id="fur" cx="50%" cy="40%">
                <stop offset="0%" stop-color="#ffeede"/>
                <stop offset="100%" stop-color="#ffe7cc"/>
              </radialGradient>
              <radialGradient id="tailGrad" cx="40%" cy="30%">
                <stop offset="0%" stop-color="#7a5845"/>
                <stop offset="100%" stop-color="#5a3f2f"/>
              </radialGradient>
              <radialGradient id="bodyShade" cx="45%" cy="35%">
                <stop offset="0%" stop-color="#fff5e8"/>
                <stop offset="70%" stop-color="#ffe7cc"/>
                <stop offset="100%" stop-color="#f5d9b8"/>
              </radialGradient>
              <radialGradient id="noseGrad" cx="40%" cy="30%">
                <stop offset="0%" stop-color="#f5a892"/>
                <stop offset="100%" stop-color="#d67861"/>
              </radialGradient>
              <linearGradient id="innerEar" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="#ffccd5"/>
                <stop offset="100%" stop-color="#f5a8b5"/>
              </linearGradient>
            </defs>

            <path d="M320 215 q70 16 70 54 q0 24 -28 18 q-18 -4 -34 -14"
                  fill="url(#tailGrad)" stroke="#4a2f1f" stroke-width="1.5"/>

            <!-- body with enhanced shading -->
            <ellipse cx="230" cy="215" rx="125" ry="72"
                     fill="url(#bodyShade)" stroke="#d7ae87" stroke-width="3"/>
            <!-- chest highlight -->
            <ellipse cx="230" cy="228" rx="85" ry="35" fill="rgba(255,255,255,.25)"/>
            <!-- calico patches with soft edges -->
            <ellipse cx="170" cy="215" rx="44" ry="28" fill="#6b4b39" opacity=".85"/>
            <ellipse cx="160" cy="210" rx="20" ry="15" fill="rgba(107,75,57,.3)"/>
            <ellipse cx="270" cy="200" rx="34" ry="22" fill="#ffb86b" opacity=".9"/>
            <ellipse cx="275" cy="195" rx="18" ry="12" fill="rgba(255,184,107,.4)"/>
            <!-- body shadow -->
            <ellipse cx="230" cy="232" rx="92" ry="40" fill="rgba(0,0,0,.08)"/>

            <!-- head with gradient -->
            <circle cx="215" cy="140" r="62" fill="url(#fur)" stroke="#d7ae87" stroke-width="3"/>

            <!-- muzzle area (cheeks) -->
            <ellipse cx="195" cy="155" rx="18" ry="12" fill="rgba(255,255,255,.6)"/>
            <ellipse cx="235" cy="155" rx="18" ry="12" fill="rgba(255,255,255,.6)"/>

            <!-- calico patches on head with depth -->
            <path d="M187 98 q-42 24 -36 60 q26-8 40-32z" fill="#6b4b39" opacity=".85"/>
            <path d="M190 105 q-25 15 -22 38 q15-5 25-20z" fill="rgba(107,75,57,.3)"/>
            <path d="M236 100 q40 22 33 58 q-22-8 -31-30z" fill="#ffb86b" opacity=".9"/>
            <path d="M238 108 q25 14 20 36 q-14-5 -19-19z" fill="rgba(255,184,107,.4)"/>

            <!-- ears with inner ear detail -->
            <path d="M168 126 l-34 -28 l18 -12 l36 30 z" fill="#ffe7cc" stroke="#d7ae87" stroke-width="3"/>
            <path d="M155 110 l-18 -15 l8 -5 l16 16 z" fill="url(#innerEar)"/>
            <path d="M262 126 l34 -28 l-18 -12 l-36 30 z" fill="#ffe7cc" stroke="#d7ae87" stroke-width="3"/>
            <path d="M275 110 l18 -15 l-8 -5 l-16 16 z" fill="url(#innerEar)"/>

            <!-- face with realistic eyes -->
            <!-- left eye -->
            <g class="eye blink">
              <ellipse cx="195" cy="142" rx="11" ry="13" fill="#e8dcc8"/>
              <ellipse cx="195" cy="142" rx="9" ry="11" fill="#6b8e4e"/>
              <ellipse cx="195" cy="142" rx="5" ry="6" fill="#2b241f"/>
              <ellipse cx="193" cy="139" rx="2" ry="3" fill="#ffffff" opacity=".9"/>
            </g>
            <!-- right eye -->
            <g class="eye blink">
              <ellipse cx="235" cy="142" rx="11" ry="13" fill="#e8dcc8"/>
              <ellipse cx="235" cy="142" rx="9" ry="11" fill="#6b8e4e"/>
              <ellipse cx="235" cy="142" rx="5" ry="6" fill="#2b241f"/>
              <ellipse cx="233" cy="139" rx="2" ry="3" fill="#ffffff" opacity=".9"/>
            </g>

            <!-- 3D nose -->
            <ellipse cx="215" cy="158" rx="5" ry="5.5" fill="url(#noseGrad)"/>
            <ellipse cx="213.5" cy="156.5" rx="1.5" ry="1.5" fill="rgba(255,255,255,.5)"/>
            <path d="M215 163 v4" stroke="#2b241f" stroke-width="1.5" stroke-linecap="round"/>

            <!-- more expressive mouth -->
            <path d="M201 169 q14 12 28 0" stroke="#2b241f" stroke-width="2.5" fill="none" stroke-linecap="round"/>
            <path d="M210 175 q5 3 10 0" stroke="#2b241f" stroke-width="1.5" fill="none" stroke-linecap="round" opacity=".6"/>

            <!-- enhanced whiskers with variation -->
            <path d="M183 154 h-30" stroke="#2b241f" stroke-width="1.5" stroke-linecap="round" opacity=".85"/>
            <path d="M247 154 h30" stroke="#2b241f" stroke-width="1.5" stroke-linecap="round" opacity=".85"/>
            <path d="M185 161 h-32" stroke="#2b241f" stroke-width="1.5" stroke-linecap="round" opacity=".85"/>
            <path d="M245 161 h32" stroke="#2b241f" stroke-width="1.5" stroke-linecap="round" opacity=".85"/>
            <path d="M184 148 l-28 -4" stroke="#2b241f" stroke-width="1.3" stroke-linecap="round" opacity=".75"/>
            <path d="M246 148 l28 -4" stroke="#2b241f" stroke-width="1.3" stroke-linecap="round" opacity=".75"/>

            <!-- hat -->
            <rect x="191" y="98" width="48" height="16" rx="4" fill="#fff" stroke="#ddd"/>
            <ellipse cx="215" cy="85" rx="36" ry="16" fill="#fff" stroke="#ddd"/>

            <!-- paws with toe beans -->
            <g class="paw" id="pawL">
              <ellipse cx="178" cy="246" rx="22" ry="14" fill="#ffe7cc" stroke="#d7ae87" stroke-width="2"/>
              <!-- toe beans -->
              <ellipse cx="178" cy="248" rx="6" ry="5" fill="#e0a8a0" opacity=".9"/>
              <ellipse cx="170" cy="244" rx="3.5" ry="3" fill="#e0a8a0" opacity=".85"/>
              <ellipse cx="175" cy="242" rx="3.5" ry="3" fill="#e0a8a0" opacity=".85"/>
              <ellipse cx="181" cy="242" rx="3.5" ry="3" fill="#e0a8a0" opacity=".85"/>
              <ellipse cx="186" cy="244" rx="3.5" ry="3" fill="#e0a8a0" opacity=".85"/>
            </g>
            <g class="paw" id="pawR">
              <ellipse cx="245" cy="246" rx="22" ry="14" fill="#ffe7cc" stroke="#d7ae87" stroke-width="2"/>
              <!-- toe beans -->
              <ellipse cx="245" cy="248" rx="6" ry="5" fill="#e0a8a0" opacity=".9"/>
              <ellipse cx="237" cy="244" rx="3.5" ry="3" fill="#e0a8a0" opacity=".85"/>
              <ellipse cx="242" cy="242" rx="3.5" ry="3" fill="#e0a8a0" opacity=".85"/>
              <ellipse cx="248" cy="242" rx="3.5" ry="3" fill="#e0a8a0" opacity=".85"/>
              <ellipse cx="253" cy="244" rx="3.5" ry="3" fill="#e0a8a0" opacity=".85"/>
            </g>
          </svg>
        </div>

        <!-- falling item -->
        <div id="fall" class="fall" style="top:190px; display:none;">üçÖ</div>
        <!-- combo badge -->
        <div id="combo" class="combo">x1</div>

        <!-- table + pizza -->
        <div class="table">
          <div class="table-shadow"></div>
          <div class="pizza-zone" id="zone">
            <div class="pizza" id="pizza"><div class="ring"></div></div>
          </div>
        </div>
      </section>

      <aside class="right">
        <div class="panel order">
          <h3>Order Ticket ‚Äî Add these toppings</h3>
          <div id="reqs" class="reqs"></div>
        </div>
        <div class="panel bubble" id="bubble">Tap the pizza when a required topping is falling!</div>
      </aside>
    </main>
  </div>

  <!-- Overlay -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true">
    <div class="card">
      <h2 id="ovTitle">Pizza Cat</h2>
      <p id="ovMsg">Catch the right toppings! Tap the pizza while a required one is over it.</p>
      <div id="ovBadges" class="grid"></div>
      <div style="display:flex; gap:8px; justify-content:center; margin-top:10px">
        <button id="ovPrimary" class="primary">Play</button>
        <button id="ovSecondary" class="secondary">How to Play</button>
      </div>
      <p class="ghost" style="margin-top:8px">Tip: Add to Home Screen for full-screen play.</p>
    </div>
  </div>

<script>
(() => {
  // Ingredients
  const ING = [
    { id:'cheese',  name:'Cheese',     emo:'üßÄ' },
    { id:'tomato',  name:'Tomato',     emo:'üçÖ' },
    { id:'pep',     name:'Pepperoni',  emo:'ü•ì' },
    { id:'mush',    name:'Mushroom',   emo:'üçÑ' },
    { id:'olive',   name:'Olive',      emo:'ü´í' },
    { id:'onion',   name:'Onion',      emo:'üßÖ' },
    { id:'pine',    name:'Pineapple',  emo:'üçç' },
    { id:'pepper',  name:'Pepper',     emo:'üå∂Ô∏è' },
    { id:'shrimp',  name:'Shrimp',     emo:'üç§' },
    { id:'leaf',    name:'Leafy Greens', emo:'ü•¨' }
  ];

  // UI
  const ui = {
    level: document.getElementById('uiLevel'),
    time:  document.getElementById('uiTime'),
    score: document.getElementById('uiScore'),
    best:  document.getElementById('uiBest'),
    bubble:document.getElementById('bubble'),
    reqs:  document.getElementById('reqs'),
    pizza: document.getElementById('pizza'),
    zone:  document.getElementById('zone'),
    fall:  document.getElementById('fall'),
    combo: document.getElementById('combo'),
    pawL:  document.getElementById('pawL'),
    pawR:  document.getElementById('pawR'),
    btnStart:document.getElementById('btnStart'),
    btnPause:document.getElementById('btnPause'),
    btnSound:document.getElementById('btnSound'),
    overlay: document.getElementById('overlay'),
    ovTitle: document.getElementById('ovTitle'),
    ovMsg:   document.getElementById('ovMsg'),
    ovBadges:document.getElementById('ovBadges'),
    ovPrimary:document.getElementById('ovPrimary'),
    ovSecondary:document.getElementById('ovSecondary')
  };

  // Audio
  let soundOn = true, AC=null;
  function beep(freq=660, dur=100, type='sine', vol=0.08){
    if(!soundOn) return;
    try{
      if(!AC) AC=new (window.AudioContext||window.webkitAudioContext)();
      const o=AC.createOscillator(), g=AC.createGain();
      o.type=type; o.frequency.value=freq; g.gain.value=vol;
      o.connect(g); g.connect(AC.destination); o.start(); setTimeout(()=>o.stop(), dur);
    }catch(e){}
  }
  const vibrate = ms => { try{ navigator.vibrate && navigator.vibrate(ms); }catch(e){} };

  // State
  let level=1, score=0, best=+localStorage.getItem('pc_best')||0; ui.best.textContent=best;
  let timeLeft=30, timer=null, running=false;
  let recipe=[], done=new Set();
  let current=null; // {ing, y, vy}
  let raf=null, spawnLock=false, lastFrame=0;
  let combo=1, lastCatchTs=0;

  // Tunables
  const TOL_RADIUS = 24;          // easier catch (was 18)
  const CATCH_BAND_TOP = -16;     // allow slight early tap
  const CATCH_BAND_BOTTOM = 10;   // allow slight late tap
  const BASE_GRAVITY = 0.10;      // smooth physics
  const DT_NORM = 16.67;

  // Helpers
  const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const sample=(arr,k)=>{const p=arr.slice(),out=[]; while(out.length<k&&p.length) out.push(p.splice(rint(0,p.length-1),1)[0]); return out;};
  function setMsg(m,c){ ui.bubble.textContent=m; ui.bubble.classList.remove('ok','bad'); if(c) ui.bubble.classList.add(c); }
  function needCount(lvl){ return Math.min(6, 2 + (lvl-1)); }
  function baseTime(lvl){ return Math.max(20, 32 - Math.floor(lvl*1.5)); }

  // Recipe
  function renderRecipe(){
    ui.reqs.innerHTML='';
    recipe.forEach(it=>{
      const div=document.createElement('div');
      div.className='req' + (done.has(it.id)?' done':'');
      div.innerHTML=`<span>${it.emo}</span> <span><strong>${it.name}</strong></span>`;
      ui.reqs.appendChild(div);
    });
  }

  // Particles (confetti burst on catch)
  function burst(x,y){
    for(let i=0;i<10;i++){
      const p=document.createElement('div');
      p.textContent = ['üçÖ','üßÄ','üçÑ','ü´í','üå∂Ô∏è','ü•¨'][i%6];
      p.style.position='fixed'; p.style.left=x+'px'; p.style.top=y+'px'; p.style.zIndex=9999;
      p.style.pointerEvents='none'; p.style.filter='drop-shadow(0 2px 1px rgba(0,0,0,.15))';
      document.body.appendChild(p);
      const ang=Math.random()*Math.PI*2, sp=2+Math.random()*3;
      const dx=Math.cos(ang)*sp, dy=Math.sin(ang)*sp;
      let life=600, start=performance.now();
      function anim(t){
        const dt=t-start; const k=dt/life;
        p.style.transform=`translate(${dx*dt/5}px,${(dy*dt/6 + 0.002*dt*dt)}px) rotate(${dt/3}deg)`;
        p.style.opacity=String(1-k);
        if(dt<life) requestAnimationFrame(anim); else p.remove();
      }
      requestAnimationFrame(anim);
    }
  }

  // Game flow
  function startLevel(){
    timeLeft=baseTime(level); ui.time.textContent=timeLeft; ui.level.textContent=level;
    recipe=sample(ING, needCount(level)); done.clear(); renderRecipe();
    ui.pizza.innerHTML='<div class="ring"></div>';
    running=true; setMsg(`Level ${level}! Tap pizza when the right topping falls.`);
    clearInterval(timer);
    timer=setInterval(()=>{ if(!running) return; timeLeft--; ui.time.textContent=timeLeft; if(timeLeft<=0){ endGame(); } },1000);
    combo=1; ui.combo.style.display='none';
    spawnNext();
  }
  function pause(){ running=false; setMsg('Paused. Tap Start to resume.'); clearRaf(); }
  function resume(){
    if(running) return;
    running=true; setMsg('Go go go!');
    lastFrame=0; animate(performance.now());
  }
  function endGame(){
    running=false; clearInterval(timer); clearRaf();
    if(score>best){best=score; localStorage.setItem('pc_best',best); ui.best.textContent=best;}
    showOverlay('Out of time! ‚è≥','The customer left‚Ä¶ Try again!',
      [`Level ${level}`,`Score ${score}`,`Best ${best}`],
      'Play Again','How to Play',
      ()=>{ level=1; score=0; ui.score.textContent=score; startLevel(); }, howTo);
  }

  // Spawn with smooth start
  function spawnNext(){
    if(!running||spawnLock) return; spawnLock=true;
    ui.pawL.classList.add('drop'); ui.pawR.classList.add('drop'); setTimeout(()=>{ui.pawL.classList.remove('drop'); ui.pawR.classList.remove('drop');},550);

    const needed = recipe.filter(r=>!done.has(r.id));
    const pickNeeded = Math.random()<0.7 && needed.length>0;
    const ing = (pickNeeded?needed:ING)[rint(0,(pickNeeded?needed:ING).length-1)];

    current={ing, y:200, vy: 0.18}; // smoother start
    ui.fall.textContent=ing.emo; ui.fall.style.top=current.y+'px'; ui.fall.style.display='block';
    ui.fall.classList.remove('squash');
    lastFrame = 0;
    animate(performance.now());
  }

  function animate(ts){
    if(!running||!current) return;
    raf=requestAnimationFrame(animate);

    if(!lastFrame) lastFrame = ts;
    const dt = Math.min(40, ts - lastFrame); lastFrame = ts;

    // easing gravity
    const g = (BASE_GRAVITY + level*0.02) * (dt/DT_NORM);
    current.vy += g;
    current.y  += current.vy * (dt/DT_NORM);
    ui.fall.style.top=current.y+'px';

    // miss when it passes the table bottom
    const tableRect = document.querySelector('.table').getBoundingClientRect();
    if(current.y > tableRect.bottom - 30){
      handleMiss();
    }
  }
  function clearRaf(){ if(raf){ cancelAnimationFrame(raf); raf=null; } }

  // Catch (forgiving but fair)
  ui.zone.addEventListener('click', tryCatch, {passive:true});
  ui.zone.addEventListener('touchstart', tryCatch, {passive:true});
  function tryCatch(ev){
    if(!running||!current) return;

    const pizzaRect = ui.pizza.getBoundingClientRect();
    const fallRect  = ui.fall.getBoundingClientRect();

    const px = pizzaRect.left + pizzaRect.width / 2;
    const py = pizzaRect.top  + pizzaRect.height / 2;
    const fx = fallRect.left  + fallRect.width / 2;
    const fy = fallRect.top   + fallRect.height / 2;

    const radius = (pizzaRect.width / 2) * 0.92;
    const inside = ((fx-px)**2 + (fy-py)**2) <= (radius + TOL_RADIUS)**2;

    // Vertical band check with grace; but disallow after it clearly passed
    if (fy < pizzaRect.top + CATCH_BAND_TOP || fy > pizzaRect.bottom + CATCH_BAND_BOTTOM) return;

    const needed = recipe.some(r => r.id === current.ing.id) && !done.has(current.ing.id);

    if (inside && needed) {
      // combo logic (3s window)
      const now = performance.now();
      combo = (now - lastCatchTs) <= 3000 ? Math.min(5, combo+1) : 1;
      lastCatchTs = now;
      showCombo();

      ui.fall.classList.add('squash');
      placeOnPizza(current.ing.emo);
      done.add(current.ing.id); renderRecipe();

      const gained = Math.round((120 + Math.floor(timeLeft*2)) * (1 + (combo-1)*0.15));
      score += gained; ui.score.textContent=score;
      setMsg(`Nice! Caught ${current.ing.name}. +${gained}`, 'ok'); beep(780,90,'sine',0.08); vibrate(20);

      // confetti burst at tap point
      if(ev && ev.touches && ev.touches[0]) burst(ev.touches[0].clientX, ev.touches[0].clientY);
      else if(ev) burst(fx, fy);

      ui.fall.style.display='none'; current=null; spawnLock=false;
      nextOrWin(); if(running) setTimeout(spawnNext, 260);
    } else if (inside && !needed) {
      timeLeft = Math.max(0, timeLeft - 3); ui.time.textContent = timeLeft;
      setMsg(`We don‚Äôt need ${current.ing.name}! -3s`, 'bad'); beep(220, 150, 'sawtooth', 0.06); vibrate(15);

      ui.fall.style.display='none'; current=null; spawnLock=false;
      if(running) setTimeout(spawnNext, 260);
    }
  }

  function showCombo(){
    if(combo<=1){ ui.combo.style.display='none'; return; }
    ui.combo.style.display='block';
    ui.combo.textContent = 'x'+combo;
    ui.combo.animate([{transform:'scale(1)'},{transform:'scale(1.15)'},{transform:'scale(1)'}],{duration:220});
  }

  function handleMiss(){
    const wasNeeded = recipe.some(r=>r.id===current.ing.id) && !done.has(current.ing.id);
    if(wasNeeded){
      timeLeft = Math.max(0, timeLeft-4); ui.time.textContent=timeLeft;
      setMsg(`Missed a required ${current.ing.name}! -4s`,'bad'); beep(160,170,'triangle',0.06); vibrate(25);
    }else{
      setMsg(`Ignored extra ${current.ing.name}.`);
    }
    ui.fall.style.display='none'; current=null; spawnLock=false;
    if(running) setTimeout(spawnNext, 320);
    clearRaf();
  }

  function nextOrWin(){
    if(done.size === recipe.length){
      running=false; clearInterval(timer); clearRaf();
      const bonus = Math.floor(timeLeft*10); score+=bonus; ui.score.textContent=score;
      if(score>best){best=score; localStorage.setItem('pc_best',best); ui.best.textContent=best;}
      showOverlay('Pizza up! üçï', `Level ${level} complete. Time bonus +${bonus}.`,
        [`Next: Level ${level+1}`, `Score ${score}`, combo>1?`Combo x${combo}`:''],
        'Next Level','How to Play', ()=>{ level++; startLevel(); }, howTo);
    }
  }

  function placeOnPizza(emo){
    const r = ui.pizza.getBoundingClientRect();
    const pad = r.width*0.18;
    const x = rint(pad, r.width-pad);
    const y = rint(pad, r.height-pad);
    const d = document.createElement('div');
    d.className='spot'; d.textContent=emo; d.style.left=x+'px'; d.style.top=y+'px';
    ui.pizza.appendChild(d);
  }

  // Overlay utilities
  function showOverlay(title,msg,badges=[],primary='Play',secondary='How to Play',onP=null,onS=null){
    ui.ovTitle.textContent=title; ui.ovMsg.textContent=msg; ui.ovBadges.innerHTML='';
    badges.filter(Boolean).forEach(b=>{const p=document.createElement('div');p.className='pill';p.textContent=b;ui.ovBadges.appendChild(p);});
    ui.overlay.classList.add('show');
    ui.ovPrimary.textContent=primary; ui.ovSecondary.textContent=secondary;
    ui.ovPrimary.onclick=()=>{ ui.overlay.classList.remove('show'); if(onP) onP(); };
    ui.ovSecondary.onclick=()=>{ if(onS) onS(); };
  }
  function howTo(){
    showOverlay('How to Play',
      'A topping drops from the calico cat. Tap the pizza ONLY while a required topping is over it. Missing a required topping or catching a wrong one costs time. Chain fast catches to build COMBO for bonus points.',
      ['Longer drop path','Realistic calico','Smooth physics','Combo bonus'],
      'Start Playing','Close',
      ()=>{ ui.overlay.classList.remove('show'); startLevel(); }, // ‚Üê start immediately after instructions
      ()=>{ ui.overlay.classList.remove('show'); });
  }

  // Buttons
  ui.btnStart.addEventListener('click', ()=>{
    try{ if(!AC) AC=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){}
    // If game not started yet or just finished instructions, start fresh
    if(!running && (!recipe.length || timeLeft===0 || done.size===recipe.length)) {
      startLevel();
    } else {
      resume();
    }
  });
  ui.btnPause.addEventListener('click', ()=>pause());
  ui.btnSound.addEventListener('click', ()=>{ soundOn=!soundOn; ui.btnSound.textContent=soundOn?'üîä':'üîá'; });

  // Boot ‚Äì show welcome overlay with direct Play
  showOverlay('Pizza Cat ‚Äî Drop Edition',
    'Catch toppings by tapping the pizza. Only catch what the order ticket shows!',
    ['Smooth physics','Forgiving catch','Combo bonus'],
    'Play','How to Play',
    ()=>startLevel(),
    ()=>howTo()
  );
})();
</script>
</body>
</html>